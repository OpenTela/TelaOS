# Методология отладки для ИИ-ассистента

## Главное правило

**СНАЧАЛА ФАКТЫ — ПОТОМ ГИПОТЕЗЫ**

Никогда не предлагай исправления на основе предположений. Сначала получи точную информацию о месте и причине ошибки.

## Порядок отладки при краше

### 1. Получи backtrace
```bash
xtensa-esp32s3-elf-addr2line -e .pio/build/waveshare_amoled/firmware.elf 0xADDR1 0xADDR2 0xADDR3
```

**Это ПЕРВОЕ действие при любом краше.** Не предлагай фиксы до получения backtrace.

### 2. Анализируй факты
- Какой файл и строка?
- Какая функция?
- Что именно делает этот код?

### 3. Один фикс за раз
- Исправь конкретную найденную проблему
- Проверь результат
- Только потом переходи к следующей проблеме

## Антипаттерны (НЕ ДЕЛАЙ ТАК)

### ❌ Хаотичная отладка
```
"Возможно это race condition... или PSRAM... или Lua стек... 
давай попробуем увеличить стек... нет, давай попробуем lock... 
нет, давай async..."
```

### ❌ Множественные изменения
Менять 5 вещей одновременно "на всякий случай" — потом непонятно что помогло.

### ❌ Гадание по симптомам
"Падает при частых действиях = race condition" — это ГИПОТЕЗА, не факт.

## Правильный подход

### ✅ Методичная отладка
```
1. Краш → получить backtrace
2. Backtrace → найти точную строку
3. Строка → понять что делает код
4. Понимание → один точечный фикс
5. Тест → подтверждение или следующий краш
```

### ✅ Минимальные изменения
Каждое изменение должно быть обосновано конкретными данными.

### ✅ Логи там где нужно
Если backtrace недоступен — добавить точечные логи в подозрительное место, не везде.

## Инструменты ESP32

### Декодирование backtrace (Windows PlatformIO)
```bash
C:\Users\USER\.platformio\packages\toolchain-xtensa-esp32s3\bin\xtensa-esp32s3-elf-addr2line.exe -e .pio\build\BOARD\firmware.elf ADDR1 ADDR2 ADDR3
```

### Мониторинг heap
```c
ESP_LOGI(TAG, "heap=%lu", (unsigned long)esp_get_free_heap_size());
```

### Проверка стека задачи
```c
ESP_LOGI(TAG, "stack free=%d", uxTaskGetStackHighWaterMark(NULL));
```

## Типичные ошибки ESP32/LVGL

| Симптом | Частая причина | Как найти |
|---------|---------------|-----------|
| LoadProhibited, EXCVADDR=0x00000008 | NULL pointer + offset | backtrace → какой объект NULL |
| Cache error, MMU fault | Доступ к освобождённой памяти | backtrace → use-after-free |
| Stack overflow | Рекурсия или большие локальные переменные | Увеличить стек задачи |
| Случайные краши при UI операциях | Обращение к удалённым LVGL объектам | Проверить lifecycle объектов |

## Чеклист перед предложением фикса

- [ ] Есть ли backtrace с точным местом краша?
- [ ] Понятно ли что именно делает код в этом месте?
- [ ] Фикс решает конкретную найденную проблему?
- [ ] Это минимальное необходимое изменение?

## Пример из практики

**Симптом:** Краши при интенсивной работе с калькулятором

**Неправильно:** "Это race condition! Давай добавим lock, async, очередь..."

**Правильно:**
```
1. addr2line → app_manager.cpp:318
2. Строка 318 → lv_obj_set_style_bg_color(s_launcherDots[i], ...)
3. s_launcherDots содержит указатели на удалённые объекты
4. Фикс: очищать вектор при загрузке приложения
```

---

*Этот документ создан на основе реального опыта отладки, где хаотичный подход занял часы, а методичный — минуты.*
